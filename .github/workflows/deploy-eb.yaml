name: Deploy to AWS Elastic Beanstalk

on:
  workflow_dispatch:
  # push:
  #   branches:
  #     - main

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v2
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Create Elastic Beanstalk Dockerrun.aws.json
        run: |
          cat > Dockerrun.aws.json <<EOF
          {
            "AWSEBDockerrunVersion": "1",
            "Image": {
              "Name": "react-app:latest",
              "Update": "true"
            },
            "Ports": [
              {
                "ContainerPort": 80,
                "HostPort": 80
              }
            ],
            "Logging": "/var/log"
          }
          EOF
          cat Dockerrun.aws.json
      
      - name: Generate deployment package
        run: |
          zip -r deploy.zip . -x "node_modules/*" ".git/*" ".github/*" "build/*" "dist/*" "*.pem" ".env*"
          ls -lh deploy.zip
      
      - name: Upload to S3 and Deploy to Elastic Beanstalk
        env:
          ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
          REGION: ${{ secrets.AWS_REGION }}
          APP_NAME: ${{ secrets.EB_APPLICATION_NAME }}
          ENV_NAME: ${{ secrets.EB_ENVIRONMENT_NAME }}
        run: |
          BUCKET_NAME="elasticbeanstalk-${REGION}-${ACCOUNT_ID}"
          VERSION_LABEL="react-app-$(date +%s)"
          
          echo "Using S3 bucket: $BUCKET_NAME"
          echo "Version label: $VERSION_LABEL"
          
          # Check if bucket exists, create if not
          if ! aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
            echo "Bucket does not exist, creating..."
            if [ "$REGION" = "us-east-1" ]; then
              aws s3api create-bucket --bucket "$BUCKET_NAME"
            else
              aws s3api create-bucket --bucket "$BUCKET_NAME" --region "$REGION" --create-bucket-configuration LocationConstraint="$REGION"
            fi
            sleep 2
          fi
          
          # Block public access
          aws s3api put-public-access-block \
            --bucket "$BUCKET_NAME" \
            --public-access-block-configuration \
            "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"
          
          echo "Uploading deployment package to S3..."
          aws s3 cp deploy.zip "s3://$BUCKET_NAME/deploys/$VERSION_LABEL.zip" --region "$REGION"
          
          echo "Creating application version..."
          aws elasticbeanstalk create-application-version \
            --application-name "$APP_NAME" \
            --version-label "$VERSION_LABEL" \
            --source-bundle "S3Bucket=$BUCKET_NAME,S3Key=deploys/$VERSION_LABEL.zip" \
            --region "$REGION"
          
          echo "Updating environment..."
          aws elasticbeanstalk update-environment \
            --application-name "$APP_NAME" \
            --environment-name "$ENV_NAME" \
            --version-label "$VERSION_LABEL" \
            --region "$REGION"
      
      - name: Wait for Beanstalk environment to be healthy
        env:
          ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
          REGION: ${{ secrets.AWS_REGION }}
          APP_NAME: ${{ secrets.EB_APPLICATION_NAME }}
          ENV_NAME: ${{ secrets.EB_ENVIRONMENT_NAME }}
        run: |
          MAX_ATTEMPTS=60
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            HEALTH=$(aws elasticbeanstalk describe-environments \
              --application-name "$APP_NAME" \
              --environment-names "$ENV_NAME" \
              --region "$REGION" \
              --query 'Environments[0].Health' \
              --output text)
            
            STATUS=$(aws elasticbeanstalk describe-environments \
              --application-name "$APP_NAME" \
              --environment-names "$ENV_NAME" \
              --region "$REGION" \
              --query 'Environments[0].Status' \
              --output text)
            
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - Status: $STATUS, Health: $HEALTH"
            
            if [ "$HEALTH" = "Green" ] && [ "$STATUS" = "Ready" ]; then
              echo "✓ Environment is healthy and ready"
              exit 0
            fi
            
            sleep 5
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          echo "✗ Environment health check timeout"
          exit 1
      
      - name: Get Beanstalk environment URL
        env:
          ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
          REGION: ${{ secrets.AWS_REGION }}
          APP_NAME: ${{ secrets.EB_APPLICATION_NAME }}
          ENV_NAME: ${{ secrets.EB_ENVIRONMENT_NAME }}
        run: |
          ENVIRONMENT_URL=$(aws elasticbeanstalk describe-environments \
            --application-name "$APP_NAME" \
            --environment-names "$ENV_NAME" \
            --region "$REGION" \
            --query 'Environments[0].CNAME' \
            --output text)
          
          echo "Environment URL: http://$ENVIRONMENT_URL"
          echo "✓ Deployment completed successfully!"