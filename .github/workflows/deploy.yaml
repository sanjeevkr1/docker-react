name: Deploy to AWS EC2
on:
  workflow_dispatch:
  # push:
  #   branches:
  #     - master

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Get EC2 Instance ID by tag
        id: get-instance
        run: |
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:instance-name,Values=react-app" "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].InstanceId' \
            --output text)
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "Instance ID: $INSTANCE_ID"
      
      - name: Verify AWS credentials
        run: aws sts get-caller-identity

      # - name: Test SSM access
      #   run: aws ssm describe-document --name AWS-RunShellScript

      - name: Ensure Docker installed and deploy via Systems Manager
        run: |
          ID=${{ steps.get-instance.outputs.instance_id }}
          echo "Instance: $ID"

          cat > install-commands.json <<'JSON'
          { "commands": [
            "#!/bin/bash -xe",
            "set -o pipefail",
            "if command -v docker >/dev/null 2>&1; then",
            "  echo docker already installed",
            "  exit 0",
            "fi",
            "if [ -f /etc/os-release ]; then . /etc/os-release; fi",
            "if echo \"$NAME\" | grep -qi 'amazon linux'; then",
            "  if command -v amazon-linux-extras >/dev/null 2>&1; then",
            "    sudo amazon-linux-extras install -y docker || true",
            "    sudo yum install -y docker || true",
            "    sudo systemctl enable docker || true",
            "    sudo systemctl start docker || sudo service docker start || true",
            "  else",
            "    sudo yum install -y docker",
            "    sudo chkconfig docker on || true",
            "    sudo service docker start",
            "  fi",
            "elif command -v yum >/dev/null 2>&1; then",
            "  sudo yum install -y docker",
            "  sudo systemctl enable docker || true",
            "  sudo systemctl start docker || sudo service docker start || true",
            "elif command -v apt-get >/dev/null 2>&1; then",
            "  sudo apt-get update -y",
            "  sudo apt-get install -y docker.io",
            "  sudo systemctl enable --now docker || sudo service docker start || true",
            "else",
            "  echo 'Unsupported distro; please install docker manually' >&2",
            "  exit 1",
            "fi",
            "sleep 3",
            "sudo docker version"
          ] }
          JSON

          echo "Sending Docker install command..."
          INSTALL_CMD_ID=$(aws ssm send-command \
            --instance-ids "$ID" \
            --document-name "AWS-RunShellScript" \
            --parameters file://install-commands.json \
            --query "Command.CommandId" --output text)
          echo "Install Command ID: $INSTALL_CMD_ID"

          echo "Waiting for install command to finish..."
          aws ssm wait command-executed --command-id "$INSTALL_CMD_ID" --instance-id "$ID"

          echo "Install result:"
          aws ssm get-command-invocation --command-id "$INSTALL_CMD_ID" --instance-id "$ID" --output text

          # prepare deploy commands (use sudo to avoid docker group issues)
          DEPLOY_PATH="${{ secrets.EC2_DEPLOY_PATH }}"
          DOCKER_USER="${{ secrets.DOCKER_USERNAME }}"
          DOCKER_PASS="${{ secrets.DOCKER_PASSWORD }}"

          cat > deploy-commands.json <<'JSON'
          { "commands": [
            "#!/bin/bash -xe",
            "set -o pipefail",
            "cd '"$DEPLOY_PATH"' || true",
            "echo Logging into Docker Hub...",
            "echo '"$DOCKER_PASS"' | sudo docker login -u '"$DOCKER_USER"' --password-stdin",
            "sudo docker pull '"$DOCKER_USER"'/react-app:latest",
            "sudo docker stop react-app || true",
            "sudo docker rm react-app || true",
            "sudo docker run -d --name react-app -p 80:80 '"$DOCKER_USER"'/react-app:latest || true",
            "sudo docker logs react-app || true"
          ] }
          JSON

          echo "Sending deploy command..."
          DEPLOY_CMD_ID=$(aws ssm send-command \
            --instance-ids "$ID" \
            --document-name "AWS-RunShellScript" \
            --parameters file://deploy-commands.json \
            --query "Command.CommandId" --output text)
          echo "Deploy Command ID: $DEPLOY_CMD_ID"

          echo "Waiting for deploy command to finish..."
          aws ssm wait command-executed --command-id "$DEPLOY_CMD_ID" --instance-id "$ID"

          echo "Deploy result:"
          aws ssm get-command-invocation --command-id "$DEPLOY_CMD_ID" --instance-id "$ID" --output text