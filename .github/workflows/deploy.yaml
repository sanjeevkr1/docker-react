name: Deploy to AWS EC2
on:
  workflow_dispatch:
  # push:
  #   branches:
  #     - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Get EC2 Instance ID by tag
        id: get-instance
        run: |
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:instance-name,Values=react-app" "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].InstanceId' \
            --output text)
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "Instance ID: $INSTANCE_ID"
      
      - name: Deploy to EC2 via Systems Manager
        run: |
          aws ssm send-command \
            --instance-ids ${{ steps.get-instance.outputs.instance_id }} \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "cd ${{ secrets.EC2_DEPLOY_PATH }}",
              "docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}",
              "docker pull ${{ secrets.DOCKER_USERNAME }}/react-app:latest",
              "docker stop react-app || true",
              "docker rm react-app || true",
              "docker run -d --name react-app -p 80:80 ${{ secrets.DOCKER_USERNAME }}/react-app:latest",
              "docker logs react-app"
            ]' \
            --output text
      
      - name: Wait for command to complete
        run: |
          COMMAND_ID=$(aws ssm list-commands \
            --filters "key=DocumentName,value=AWS-RunShellScript" \
            --query 'Commands[0].CommandId' \
            --output text)
          
          for i in {1..30}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id $COMMAND_ID \
              --instance-id ${{ steps.get-instance.outputs.instance_id }} \
              --query 'Status' \
              --output text)
            
            if [ "$STATUS" = "Success" ]; then
              echo "Deployment successful"
              exit 0
            elif [ "$STATUS" = "Failed" ]; then
              echo "Deployment failed"
              exit 1
            fi
            
            sleep 2
          done
          echo "Deployment timeout"
          exit 1